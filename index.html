<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alpine AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Uygulama için gerekli CSS stilleri */
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
      
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body, #root { height: 100%; overflow: hidden; }
      body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
      
      /* Markdown stilleri - kod bloklarını öne çıkarmak için */
      .markdown-content pre {
        background-color: #1e293b; 
        color: #f8fafc; 
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 1rem;
      }
      .markdown-content code {
        background-color: #e2e8f0; 
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        color: #334155; 
      }
      .markdown-content pre code {
        background-color: transparent;
        padding: 0;
        color: inherit;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-router-dom@6.23.1/dist/umd/react-router-dom.production.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sonner@1.4.4/dist/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-markdown@9.0.1/lib/react-markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rehype-highlight@7.0.0/lib/rehype-highlight.min.js"></script>

    <script>
    /**
     * ALPINE AI CHAT APP - İNDEX.HTML İÇİNDE YERLEŞİK KOD
     * ZAMANLAMA HATASI DÜZELTME: Tüm kod bir 'DOMContentLoaded' event listener'ına sarılmıştır.
     * React Router bileşenleri App içerisinde doğrudan 'window.ReactRouterDOM' objesinden çekilmiştir.
     */

    // SADECE GLOBAL SABİTLER BURADA KALMALIDIR
    const BACKEND_URL = 'https://alpinetr-backend.onrender.com';
    const API = `${BACKEND_URL}/api`;
    const BASE_API = '/api'; 

    // --- Auth Bileşeni ---
    const Auth = function ({ onLogin }) {
      const useState = React.useState;
      const toast = window.Sonner.toast;
      const axios = window.axios; 
      const { AtSign, Lock, User, LogIn, UserPlus } = window.lucide.icons || {}; // Güvenli erişim

      const [isLogin, setIsLogin] = useState(true);
      const [formData, setFormData] = useState({
        email: '',
        password: '',
        full_name: ''
      });
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
          const endpoint = isLogin ? '/auth/login' : '/auth/register';
          const payload = isLogin
            ? { email: formData.email, password: formData.password }
            : formData;

          const response = await axios.post(`${API}${endpoint}`, payload);
          
          if (response.data.token && response.data.user) {
            onLogin(response.data.token, response.data.user);
            toast.success(`Başarıyla ${isLogin ? 'giriş yapıldı' : 'kayıt olundu'}!`);
          } else {
            toast.error('Giriş/Kayıt hatası: Yanıt yapısı beklenmedik.');
          }
        } catch (error) {
          const errorMessage = error.response?.data?.message || 'Bir hata oluştu. Lütfen tekrar deneyin.';
          toast.error(errorMessage);
        } finally {
          setLoading(false);
        }
      };

      const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };
      
      const iconProps = { className: 'w-5 h-5 text-gray-400' };

      const input = (name, type, placeholder, iconComponent, required = true) => React.createElement(
        'div',
        { key: name, className: 'relative' },
        React.createElement(
          'div',
          { className: 'absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none' },
          iconComponent ? React.createElement(iconComponent, iconProps) : null
        ),
        React.createElement(
          'input',
          {
            type: type,
            name: name,
            placeholder: placeholder,
            required: required,
            value: formData[name],
            onChange: handleChange,
            className: 'w-full py-3 pl-10 pr-4 text-gray-700 placeholder-gray-400 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm'
          }
        )
      );

      return React.createElement(
        'div',
        { className: 'min-h-screen flex items-center justify-center p-4 bg-gray-50' },
        React.createElement(
          'div',
          { className: 'w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-2xl' },
          React.createElement(
            'div',
            { className: 'text-center' },
            React.createElement(
              'h1',
              { className: 'text-3xl font-extrabold text-gray-900 tracking-tight font-space-grotesk' },
              isLogin ? 'Giriş Yap' : 'Kayıt Ol'
            ),
            React.createElement(
              'p',
              { className: 'mt-2 text-sm text-gray-600' },
              isLogin ? 'Hesabınıza giriş yapın' : 'Yeni bir hesap oluşturun'
            )
          ),
          React.createElement(
            'form',
            { onSubmit: handleSubmit, className: 'mt-8 space-y-6' },
            !isLogin && input('full_name', 'text', 'Ad Soyad', User),
            input('email', 'email', 'E-posta Adresi', AtSign),
            input('password', 'password', 'Şifre', Lock),
            React.createElement(
              'button',
              {
                type: 'submit',
                disabled: loading,
                className: 'w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50',
              },
              loading ? 'Yükleniyor...' : (isLogin ? React.createElement(LogIn, { className: 'w-5 h-5 mr-2' }) : React.createElement(UserPlus, { className: 'w-5 h-5 mr-2' })),
              loading ? '' : (isLogin ? 'Giriş Yap' : 'Kayıt Ol')
            ),
            React.createElement(
              'div',
              { className: 'text-center pt-4' },
              React.createElement(
                'p',
                { className: 'text-sm text-gray-600' },
                isLogin ? 'Hesabınız yok mu?' : 'Zaten bir hesabınız var mı?',
                React.createElement(
                  'button',
                  { 
                    type: 'button',
                    onClick: () => setIsLogin(!isLogin),
                    className: 'ml-1 font-medium text-indigo-600 hover:text-indigo-500 transition duration-150 ease-in-out'
                  },
                  isLogin ? 'Kayıt Ol' : 'Giriş Yap'
                )
              )
            )
          )
        )
      );
    };

    // --- Chat Bileşeni ---
    const Chat = function ({ token, user, onLogout }) {
      const useState = React.useState;
      const useEffect = React.useEffect;
      const useRef = React.useRef;
      const toast = window.Sonner.toast;
      const axios = window.axios; 
      const ReactMarkdown = window.ReactMarkdown; 
      const rehypeHighlight = window.rehypeHighlight;

      const { LogOut, Send, Menu, MessageSquare, Trash2, Plus, Loader2, UserCircle, Bot } = window.lucide.icons || {};
      
      const [message, setMessage] = useState('');
      const [messages, setMessages] = useState([]);
      const [loading, setLoading] = useState(false);
      const [conversations, setConversations] = useState([]);
      const [currentConversationId, setCurrentConversationId] = useState(null);
      const [isSidebarOpen, setIsSidebarOpen] = useState(false);
      const messagesEndRef = useRef(null);

      const authAxios = axios.create({
        baseURL: API,
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
      });

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        fetchConversations();
        const handleResize = () => {
          setIsSidebarOpen(window.innerWidth >= 1024); // lg breakpoint
        };
        handleResize();
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, [token]);
      
      useEffect(() => {
        if (currentConversationId) {
          fetchMessages(currentConversationId);
        } else {
          setMessages([]);
        }
      }, [currentConversationId, token]);

      const fetchConversations = async () => {
        try {
          const response = await authAxios.get('/conversations');
          setConversations(response.data);
          if (response.data.length > 0 && !currentConversationId) {
            setCurrentConversationId(response.data[0].id);
          } else if (response.data.length > 0 && currentConversationId && !response.data.some(c => c.id === currentConversationId)) {
             setCurrentConversationId(response.data[0].id);
          } else if (response.data.length === 0) {
            setCurrentConversationId(null);
          }
        } catch (error) {
          console.error('Konuşmalar getirilemedi:', error);
        }
      };

      const fetchMessages = async (id) => {
        try {
          const response = await authAxios.get(`/conversations/${id}/messages`);
          setMessages(response.data);
        } catch (error) {
          console.error('Mesajlar getirilemedi:', error);
          setMessages([]);
        }
      };
      
      const handleNewConversation = async () => {
        setCurrentConversationId(null);
        setMessages([]);
        setIsSidebarOpen(window.innerWidth >= 1024); // Mobil'de kapalı kalsın
      };
      
      const handleDeleteConversation = async (e, id) => {
        e.stopPropagation();
        if (!window.confirm('Bu konuşmayı silmek istediğinizden emin misiniz?')) return;
        
        try {
          await authAxios.delete(`/conversations/${id}`);
          toast.success('Konuşma başarıyla silindi.');
          
          const newConversations = conversations.filter(c => c.id !== id);
          setConversations(newConversations);
          
          if (id === currentConversationId) {
            if (newConversations.length > 0) {
              setCurrentConversationId(newConversations[0].id);
            } else {
              setCurrentConversationId(null);
            }
          }
        } catch (error) {
          const errorMessage = error.response?.data?.message || 'Silme işlemi başarısız oldu.';
          toast.error(errorMessage);
        }
      };

      const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!message.trim() || loading) return;

        const userMessage = message.trim();
        const tempMessage = { id: Date.now(), role: 'user', content: userMessage, created_at: new Date().toISOString() };
        setMessages((prev) => [...prev, tempMessage]);
        setMessage('');
        setLoading(true);

        try {
          let conversationIdToUse = currentConversationId;
          
          if (!conversationIdToUse) {
            const newConvResponse = await authAxios.post('/conversations', {
              title: userMessage.substring(0, 30) 
            });
            conversationIdToUse = newConvResponse.data.id;
            setCurrentConversationId(conversationIdToUse);
            setConversations(prev => [newConvResponse.data, ...prev]);
          }
          
          const response = await authAxios.post(`/conversations/${conversationIdToUse}/messages`, {
            message: userMessage,
            conversation_id: conversationIdToUse
          });
          
          const botMessage = response.data.response;
          setMessages((prev) => [...prev, botMessage]);
          
          if (currentConversationId !== conversationIdToUse) {
             fetchConversations();
          }
          
        } catch (error) {
          const errorMessage = error.response?.data?.message || 'Mesaj gönderme başarısız oldu.';
          toast.error(errorMessage);
          setMessages((prev) => prev.filter((m) => m.id !== tempMessage.id));
        } finally {
          setLoading(false);
        }
      };

      const Sidebar = () => React.createElement(
        'div',
        {
          className: `fixed z-40 top-0 left-0 h-full w-64 bg-gray-50 border-r border-gray-200 p-4 transform transition-transform duration-300 ease-in-out lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0 shadow-xl' : '-translate-x-full'}`
        },
        React.createElement(
          'div',
          { className: 'flex justify-between items-center mb-6' },
          React.createElement(
            'h2',
            { className: 'text-xl font-bold text-gray-800' },
            'Alpine AI'
          ),
          React.createElement(
            'button',
            { 
              onClick: () => setIsSidebarOpen(false),
              className: 'lg:hidden p-2 rounded-full hover:bg-gray-200'
            },
            React.createElement(Menu, { className: 'w-6 h-6 text-gray-600 rotate-90' })
          )
        ),
        React.createElement(
          'button',
          {
            onClick: handleNewConversation,
            className: 'w-full flex items-center justify-center p-3 mb-4 text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md'
          },
          React.createElement(Plus, { className: 'w-5 h-5 mr-2' }),
          'Yeni Konuşma'
        ),
        React.createElement(
          'div',
          { className: 'overflow-y-auto flex-grow h-[calc(100vh-140px)] space-y-2' },
          conversations.map((conv) => React.createElement(
            'div',
            {
              key: conv.id,
              onClick: () => {
                setCurrentConversationId(conv.id);
                setIsSidebarOpen(window.innerWidth >= 1024);
              },
              className: `flex items-center justify-between p-3 rounded-xl cursor-pointer transition duration-150 ease-in-out ${
                conv.id === currentConversationId ? 'bg-indigo-100 text-indigo-800 font-semibold shadow-inner' : 'hover:bg-gray-100 text-gray-700'
              }`
            },
            React.createElement(
              'div',
              { className: 'flex items-center truncate' },
              React.createElement(MessageSquare, { className: 'w-4 h-4 mr-2' }),
              React.createElement('span', { className: 'truncate text-sm' }, conv.title)
            ),
            React.createElement(
              'button',
              { 
                onClick: (e) => handleDeleteConversation(e, conv.id),
                className: 'p-1 ml-2 rounded-full hover:bg-red-200 text-gray-500 hover:text-red-600 transition'
              },
              React.createElement(Trash2, { className: 'w-4 h-4' })
            )
          ))
        ),
        React.createElement(
          'div',
          { className: 'absolute bottom-0 left-0 w-full p-4 border-t border-gray-200 bg-gray-50' },
          React.createElement(
            'div',
            { className: 'flex items-center justify-between' },
            React.createElement(
              'span',
              { className: 'text-sm text-gray-600 truncate' },
              'Kullanıcı: ',
              React.createElement('b', null, user?.full_name || 'Misafir')
            ),
            React.createElement(
              'button',
              {
                onClick: onLogout,
                className: 'flex items-center p-2 text-sm text-red-600 rounded-xl hover:bg-red-100 transition'
              },
              React.createElement(LogOut, { className: 'w-4 h-4 mr-1' }),
              'Çıkış Yap'
            )
          )
        )
      );

      const MessageBubble = ({ msg }) => {
        const isUser = msg.role === 'user';
        
        const markdownProps = {
          children: msg.content,
          rehypePlugins: [rehypeHighlight],
          className: 'markdown-content prose prose-sm max-w-none'
        };

        return React.createElement(
          'div',
          { className: `flex mb-4 ${isUser ? 'justify-end' : 'justify-start'}` },
          React.createElement(
            'div',
            {
              className: `max-w-3xl p-4 rounded-3xl shadow-md ${
                isUser
                  ? 'bg-indigo-600 text-white rounded-br-none prose-invert'
                  : 'bg-white text-gray-800 rounded-tl-none border border-gray-200'
              }`
            },
            React.createElement(
              'div',
              { className: `flex items-start mb-2 ${isUser ? 'text-white' : 'text-gray-800'}` },
              isUser
                ? React.createElement(UserCircle, { className: 'w-5 h-5 mr-2' })
                : React.createElement(Bot, { className: 'w-5 h-5 mr-2' }),
              React.createElement('span', { className: 'font-semibold text-sm' }, isUser ? user?.full_name : 'Alpine Bot')
            ),
            React.createElement(ReactMarkdown, markdownProps)
          )
        );
      };

      return React.createElement(
        'div',
        { className: 'flex h-screen bg-gray-50' },
        React.createElement(Sidebar, null),
        React.createElement(
          'div',
          { className: `flex-1 flex flex-col transition-all duration-300 ${isSidebarOpen ? 'lg:ml-64' : 'lg:ml-0'}` },
          React.createElement(
            'header',
            { className: 'flex items-center p-4 border-b border-gray-200 bg-white shadow-sm sticky top-0 z-30' },
            React.createElement(
              'button',
              { 
                onClick: () => setIsSidebarOpen(true),
                className: 'lg:hidden p-2 mr-4 rounded-full hover:bg-gray-100'
              },
              React.createElement(Menu, { className: 'w-6 h-6 text-gray-700' })
            ),
            React.createElement(
              'h1',
              { className: 'text-lg font-semibold text-gray-800 truncate' },
              currentConversationId 
                ? conversations.find(c => c.id === currentConversationId)?.title || 'Konuşma Yükleniyor...'
                : 'Yeni Konuşma'
            )
          ),
          React.createElement(
            'main',
            { className: 'flex-1 p-4 overflow-y-auto' },
            messages.length > 0 ? (
              messages.map((msg) => React.createElement(MessageBubble, { key: msg.id, msg: msg }))
            ) : (
              React.createElement(
                'div',
                { className: 'flex flex-col items-center justify-center h-full text-center text-gray-500 p-8' },
                React.createElement(Bot, { className: 'w-16 h-16 mb-4 text-gray-300' }),
                React.createElement('h2', { className: 'text-xl font-semibold mb-2' }, 'Sana Nasıl Yardımcı Olabilirim?'),
                React.createElement('p', null, 'Yeni bir sohbet başlatmak için aşağıdaki alana bir mesaj yazın.')
              )
            ),
            loading && React.createElement(
                'div', 
                { className: 'flex justify-start mb-4' }, 
                React.createElement(Loader2, { className: 'w-6 h-6 mr-2 animate-spin text-indigo-600' }), 
                React.createElement('span', { className: 'text-gray-600' }, 'Alpine düşünüyor...')
            ),
            React.createElement('div', { ref: messagesEndRef })
          ),
          React.createElement(
            'footer',
            { className: 'p-4 border-t border-gray-200 bg-white sticky bottom-0 z-30' },
            React.createElement(
              'form',
              { onSubmit: handleSendMessage, className: 'flex max-w-4xl mx-auto' },
              React.createElement(
                'input',
                {
                  type: 'text',
                  value: message,
                  onChange: (e) => setMessage(e.target.value),
                  placeholder: loading ? 'Cevap bekleniyor...' : 'Bir mesaj yazın...',
                  disabled: loading,
                  className: 'flex-1 p-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-inner transition duration-150',
                }
              ),
              React.createElement(
                'button',
                {
                  type: 'submit',
                  disabled: loading || !message.trim(),
                  className: 'flex items-center justify-center p-3 text-white bg-indigo-600 rounded-r-xl hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50 shadow-md'
                },
                loading
                  ? React.createElement(Loader2, { className: 'w-5 h-5 animate-spin' })
                  : React.createElement(Send, { className: 'w-5 h-5' })
              )
            )
          )
        )
      );
    };

    // --- App Bileşeni (Ana Uygulama) ---
    const App = function () {
      const useState = React.useState;
      const useEffect = React.useEffect;
      const createElement = React.createElement;
      const RRD = window.ReactRouterDOM; // React Router DOM objesini direkt al
      
      const { BrowserRouter, Routes, Route, Navigate } = RRD || {}; // Bileşenleri buradan al
      const Toaster = window.Sonner ? window.Sonner.Toaster : 'div';
      
      const [token, setToken] = useState(null);
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const storedToken = localStorage.getItem('token');
        const storedUser = localStorage.getItem('user');
        
        if (storedToken && storedUser) {
          setToken(storedToken);
          try {
            setUser(JSON.parse(storedUser));
          } catch (e) {
            localStorage.removeItem('user');
            setToken(null);
          }
        }
        setLoading(false);
      }, []);

      const handleLogin = (newToken, newUser) => {
        localStorage.setItem('token', newToken);
        localStorage.setItem('user', JSON.stringify(newUser));
        setToken(newToken);
        setUser(newUser);
      };

      const handleLogout = () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        setToken(null);
        setUser(null);
      };

      if (loading) {
        return createElement('div', { className: 'flex items-center justify-center min-h-screen text-lg font-bold text-indigo-600' }, 
            createElement(window.lucide.icons.Loader2, { className: 'w-6 h-6 mr-2 animate-spin' }), 
            'Uygulama Yükleniyor...'
        );
      }
      
      // KRİTİK KONTROL: Eğer RRD veya Routes hala undefined ise, bir hata mesajı göster.
      if (!RRD || !RRD.Routes) {
        return createElement('div', { className: 'p-8 text-red-600 font-bold' }, 'Hata: React Router DOM Yüklenemedi. Lütfen internet bağlantınızı kontrol edin veya tarayıcı önbelleğini temizleyin.');
      }
      

      return createElement(
        BrowserRouter,
        null,
        createElement(Toaster, {
          position: 'bottom-center'
        }),
        createElement(
          Routes,
          null,
          createElement(Route, {
            path: '/auth',
            element: token ? createElement(Navigate, { to: '/' }) : createElement(Auth, { onLogin: handleLogin })
          }),
          createElement(Route, {
            path: '/',
            element: token ? createElement(Chat, { token: token, user: user, onLogout: handleLogout }) : createElement(Navigate, { to: '/auth' })
          }),
          createElement(Route, {
            path: '*',
            element: createElement(Navigate, { to: token ? '/' : '/auth' })
          })
        )
      );
    };

    // Uygulamayı Başlatma
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('root');
        
        if (container) {
            // createRoot, ReactDOM'un içinden alınır.
            ReactDOM.createRoot(container).render(
                React.createElement(React.StrictMode, null, 
                    React.createElement(App, null)
                )
            );
        } else {
            console.error("Hata: 'root' elementi bulunamadı.");
        }
    });
    </script>
  </body>
</html>
